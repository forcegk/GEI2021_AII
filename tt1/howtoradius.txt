#Comprobamos que la configuracion ldap es
#correcta

ldapsearch -D 'cn=root,dc=tt1,dc=pri' -w 'pc1234' -h '127.0.0.1' -b 'ou=users,dc=tt1,dc=pri'

cd /etc/raddb/

#Añadimos la config obtenida antes

vim mods-available/ldap
	server = '127.0.0.1'
	identity = 'cn=root,dc=tt1,dc=pri'
	password = 'pc1234'
	base_dn = 'ou=users,dc=tt1,dc=pri'
	
	user {
		filter = "(sn=%{%{Stripped-User-Name}:-%{User-Name}})"
	}

ln -s ../mods-available/ldap ../mods-enabled/ldap

#Para usar eap si falla ldap
cd certs
make #Va a tardar un siglo
cd ..

vim clients.conf
#Comentar todo
	client pfsense {
		ipaddr		= 192.168.1.1
		secret		= pc1234
	}

vim users

#Yo creo que esto sobra, lo hice en el pasado
#no se porque, no quiero saber porque
admin Cleartext-Password := "pc1234"
	Class = "pfsense-admin"
	
#ya debería funcionar, de todas formas:

radiusd -CX #Checkea la config
radiusd -X #Inicia en modo debug

#No se como hacer un more del live feed, asi 
#que normalmente hacia
out=$(radiusd -X)
echo "$out" | more
#
echo "$out" > log

########## EN PFSENSE ###########
System -> User Manager -> Authentication Servers -> Add

	Descripcion: radius para identificar al servidor
	Type: RADIUS
	Protocol: PAP
	Hostname or IP Address: 192.168.1.200
	Shared secret: pc1234
	Services Offered: Authentication
	AUTH PORT: 1812
	ACCO PORT: 1813
	auth timeout: 5
	RADIUS NAS IP ATTIRBUTE: OPT1 - 192.168.2.1
	
Save

#Para comprobar que vaya bien
Diagnostics -> Authentication
	Authentication Server: radius para identificar al servidor
	Username: cliente1
	Password: cliente1
	
#Si no conecta, probamos con:
	Username: admin
	Password: pc1234
#Si no funciona, es que radius no está activo
#o bien configurado, si funciona, es que 
#radius no está hablando con ldap

Services -> Captive Portal
editar clientes	-> Authentication
	Authentication Server: Radius para identificar...
	Secondary auth: No marcamos nada
Save